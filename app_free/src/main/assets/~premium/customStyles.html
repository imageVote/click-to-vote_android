
<div class="overthrow">
    <br/>

    <div id="p_head">
        <div class="p_title" lang="CustomStyles"></div>
        <div><a id="p_defaults" class="link" lang="defaults"></a></div>
    </div>

    <br/><br/>

    <table id="p_colors">                    
        <tr>
            <td style="white-space: nowrap" class="p_text" lang="Symbol"></td>
            <!--<td id="fileSelect"> <input type="file" accept='image/*'></td>-->
            <td id="fileSelect"><button lang="ChooseFile"></button></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" lang="QuestionColor"></td>
            <td class="p_color"> <input id="p_questionColor" type="color"></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" lang="OptionTextColor"></td>
            <td class="p_color"> <input id="p_textColor" type="color"></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" class="p_text" lang="BackgroundColor"></td>
            <td class="p_color"> <input id="p_backgroundColor" type="color"></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" class="p_text" lang="GradientBackground"></td>
            <td class="p_color"> <input id="p_gradientBackground" type="color"></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" class="p_text" lang="GradientColor1"></td>
            <td class="p_color"> <input id="p_color1" class="p_gradientColor" type="color"></td>
        </tr>
        <tr>
            <td style="white-space: nowrap" lang="GradientColor2"></td>
            <td class="p_color" style="width:100%"> <input id="p_color2" class="p_gradientColor" type="color"></td>
        </tr>
    </table>
    <hr/>
    <div id="p_gradient"></div>
    <hr/>
    <table id="styleSaver" style="width:100%">
        <tr>
            <td id="styleInput">
                <input type="text"/>
            </td>
            <td id="saveStyle" style="text-align:center">
                <a class="link disabled" lang="SaveStyle"></a>
            </td>
        </tr>
    </table>
    <div id="savedStyles"></div>

    <br/><br/>
</div>

<script>
    init();
    translateTags(); //start lang

    //load Styles
    for (var i = 0; i < localStorage.length; i++) {
        var name = localStorage.key(i);
        if ("style_" == name.substr(0, 6)) {
            var arr = name.split("_");
            arr.shift();
            customStyles.addToList(arr.join("_"));
        }
    }

    //start draw
    customStyles.updatePickers(screenPoll.style);
    customStyles.draw();


    //EVENTS
    $("#p_defaults").click(function () {
        customStyles.restoreDefault();
        customStyles.draw();
    });

    $("#styleInput input").keypress(function () {
        $("#saveStyle a").removeClass("disabled");
    });

    $("#saveStyle").click(function () {
        var name = $("#styleInput input").val();
        if (!name) {
            flash("need name te save");
            return;
        }

        $("#saveStyle a").addClass("disabled");
        customStyles.addToList(name);
        customStyles.loadData(name);
    });

    $(document).on("swiperight", function (e) {
        if (!$(".votation.moving").length && !$("#body.pollsView").length && !$("#body.swiping").length) {
            customStyles.show();
        }
    }).on("swipeleft", function (e) {
        if ($("#p_menu").hasClass("p_show")) {
            customStyles.hide();
            $("#body").addClass("swiping");
            setTimeout(function () {
                $("#body").removeClass("swiping");
            }, 1);
        }
    });

    $("#p_menu").on("tap", function (e) {
        if ("p_menu" == $(e.target).attr("id")) {
            customStyles.hide();
        }
    });

    $("#create").click(function () {
        customStyles.draw();
    });

    $(".menuIcon").click(function () {
        customStyles.show();
    });

    //every color
    $(".p_color input").change(function () {
        console.log("change")
        customStyles.draw();
        $("#saveStyle a").removeClass("disabled");
    });


    //create object first
    function init() {
        window.customStyles = {
            show: function () {
                $("#p_menu").addClass("p_show");
            }
            ,
            hide: function () {
                $("#p_menu").removeClass("p_show");
            }
            ,
            draw: function (question, options) {
                //on every change
                var obj = screenPoll.obj;
                console.log(JSON.stringify(obj));

                if (obj.options) {
                    options = sortOptions(obj);
                    question = obj.question;
                }

                //ctx = $("#p_gradient canvas")[0].getContext("2d");
                var width = $("#p_gradient").width();

                var style = {};
                style.questionColor = toRGB($("#p_questionColor").val());
                style.textColor = toRGB($("#p_textColor").val());
                style.backgroundColor = toRGB($("#p_backgroundColor").val());
                style.gradientBackground = toRGB($("#p_gradientBackground").val());
                style.color1 = toRGB($("#p_color1").val());
                style.color2 = toRGB($("#p_color2").val());

                style.owner = transl("ownerNameExample");

                if ("undefined" == typeof question) {
                    question = lang["ExampleQuestion"];
                }
                if ("undefined" == typeof options) {
                    options = [[0, lang["OptionExample1"], 3], [1, lang["OptionExample2"], 1]];
                }

                this.poll = new poll({
                    style: style,
                    width: width,
                    question: question,
                    options: options
                }); //draw image

                this.poll.drawCanvas(function (canvas) {
                    $("#p_gradient").html(canvas);
                });
            }
            ,
            addToList: function (name) {
                var exists = $("#savedStyles p[style=" + name + "]").length;
                if (!exists) {
                    var p = $("<p style='" + name + "'>" + name + "</p>");
                    $("#savedStyles").append(p);
                    customStyles.loadEvent(p, name);
                }
            }
            ,
            loadEvent: function (div, name) {
                div.click(function () {
                    var json = localStorage.getItem("style_" + name);

                    screenPoll.style = JSON.parse(json);
                    customStyles.updatePickers(screenPoll.style);

                    customStyles.loadData(name);
                    customStyles.draw();
                    $(".selected").removeClass("selected");
                    $("#savedStyles > p[style=" + name + "]").addClass("selected");
                });
            }
            ,
            loadData: function (name) {
                localStorage.setItem("style_" + name, JSON.stringify(style));
                // DELETE STYLE LINK
                var a = $("<a id='deleteStyle' class='link'>delete style</a>");
                a.click(function () {
                    $("#confirmDeletion").show();
                    $("#confirmDeletion > div").html(lang["Delete"] + " <b>" + name + "</b>?");

                    $("#confirmDeletion .ok").one("click.deletion", function () {
                        localStorage.removeItem("style_" + name);
                        customStyles.restoreDefault();
                        $("#savedStyles > p[style=" + name + "]").remove();
                        customStyles.draw();
                    });
                });

                $("#p_head .p_title").html(name + ": ").append(a);
                $("#styleInput input").val(name);
            }
            ,
            restoreDefault: function () {
                screenPoll.style = $.extend({}, defaultStyle);
                customStyles.updatePickers(screenPoll.style);
                $("#p_head .p_title").text(lang["CustomStyles"]);
                $("#savedStyles .selected").removeClass("selected");
            }
            ,
            //colors
            updatePickers: function () {
                var style = screenPoll.style;
                $("#p_questionColor").val(toHEX(style.questionColor));
                $("#p_textColor").val(toHEX(style.textColor));
                $("#p_backgroundColor").val(toHEX(style.backgroundColor));
                $("#p_gradientBackground").val(toHEX(style.gradientBackground));
                $("#p_color1").val(toHEX(style.color1));
                $("#p_color2").val(toHEX(style.color2));
            }
            ,
            //FROM DEVICE
            newIconLoad: function (data) {
                appIcon.src = "data:image/png;base64," + data;
                p.draw();
            }
        };
    }

    //UTILS
    function toRGB(hex) {
        var rgb = [];
        var array = hex.substr(1).match(/.{1,2}/g);
        for (var i = 0; i < array.length; i++) {
            rgb.push(parseInt(array[i], 16));
        }
        return rgb;
    }

    function toHEX(arr) {
        return "#" + componentToHex(arr[0]) + componentToHex(arr[1]) + componentToHex(arr[2]);
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

</script>
